<div class="dashboard">
  <header class="dashboard__header">
    <div>
      <h1>Mis citas</h1>
      <p>Reserva, consulta tu historial y mantente al dia con tus atenciones.</p>
    </div>
    <div class="dashboard__actions">
      <a routerLink="/menu" class="btn btn--light">Menu principal</a>
      <button class="btn btn--secondary" (click)="logout()">
        Cerrar sesion
      </button>
    </div>
  </header>

  <section class="reserva card card--glass">
    <div class="reserva__encabezado">
      <h2>Reserva una nueva cita</h2>
      <p>Selecciona odontologo, fecha y horario disponible.</p>
    </div>

    <div class="reserva__grid grid grid--auto">
      <div class="campo">
        <label>Odontologo</label>
        <select
          [(ngModel)]="selectedOdontologoId"
          name="odontologo"
          (change)="onSeleccionarOdontologo()"
        >
          <option [ngValue]="null">Selecciona un odontologo</option>
          <option *ngFor="let odontologo of odontologos" [ngValue]="odontologo.id">
            {{ obtenerEtiquetaOdontologo(odontologo) }}
          </option>
        </select>
      </div>

      <div class="campo">
        <label>Fecha</label>
        <input
          type="date"
          [(ngModel)]="selectedFecha"
          name="fecha"
          (change)="limpiarDisponibilidad()"
        />
      </div>

      <div class="campo campo--boton">
        <button
          type="button"
          class="btn btn--primary"
          (click)="onBuscarSlots()"
          [disabled]="buscandoSlots || !selectedOdontologoId || !selectedFecha"
        >
          {{ buscandoSlots ? 'Buscando...' : 'Ver horarios' }}
        </button>
      </div>
    </div>

    <div class="slots" *ngIf="slotsDisponibles.length">
      <header class="slots__header">
        <h3>Horarios disponibles</h3>
        <span>Duracion aproximada: {{ duracionSlot || 30 }} minutos</span>
      </header>
      <div class="slots__grid">
        <button
          type="button"
          class="slot"
          *ngFor="let slot of slotsDisponibles"
          (click)="onSeleccionarSlot(slot)"
          [class.slot--seleccionado]="slotSeleccionado?.inicio === slot.inicio"
        >
          {{ slot.etiqueta }}
        </button>
      </div>
    </div>

    <div class="ocupadas" *ngIf="slotsOcupados.length">
      <header class="slots__header">
        <h3>Citas ocupadas</h3>
        <span>{{ slotsOcupados.length }} reservas</span>
      </header>
      <div class="tabla tabla--compacta">
        <div class="tabla__head">
          <div>Hora</div>
          <div>Estado</div>
        </div>
        <div class="tabla__row" *ngFor="let o of slotsOcupados">
          <div>{{ o.inicio | date:'HH:mm' }} - {{ o.fin | date:'HH:mm' }}</div>
          <div>{{ o.estado }}</div>
        </div>
      </div>
    </div>

    <textarea
      class="campo campo--textarea"
      [(ngModel)]="motivo"
      name="motivo"
      placeholder="Describe brevemente el motivo de tu consulta (opcional)"
    ></textarea>

    <div class="reserva__accion">
      <button
        type="button"
        class="btn btn--accent"
        (click)="onReservar()"
        [disabled]="creandoCita || !slotSeleccionado"
      >
        {{ creandoCita ? 'Reservando...' : 'Confirmar cita' }}
      </button>
    </div>
  </section>

  <!-- Calendario semanal -->
  <section class="modulo__seccion">
    <div class="agenda-controls">
      <div class="left">
        <button class="btn btn--secondary" (click)="prevWeek()">◀ Semana</button>
        <button class="btn btn--light" (click)="todayWeek()">Hoy</button>
        <button class="btn btn--secondary" (click)="nextWeek()">Semana ▶</button>
      </div>
      <div class="right">
        <label>Vista:</label>
        <select [(ngModel)]="viewMode">
          <option value="week">Semana</option>
          <option value="list">Lista</option>
        </select>
      </div>
    </div>

    <div class="week" *ngIf="viewMode==='week'">
      <div class="legend">
        <span><span class="dot dot--pendiente"></span>Pendiente</span>
        <span><span class="dot dot--confirmada"></span>Confirmada</span>
        <span><span class="dot dot--atendida"></span>Atendida</span>
        <span><span class="dot dot--cancelada"></span>Cancelada</span>
      </div>
      <div class="week__header">
        <div class="week__timecol"></div>
        <div class="week__day" *ngFor="let d of weekDays">
          <span class="week__day-label">{{ d.label }}</span>
          <div class="week__day-badges">
            <span class="badge badge--today" *ngIf="isToday(d.iso)">Hoy</span>
            <span class="badge badge--tomorrow" *ngIf="isTomorrow(d.iso)">Mañana</span>
          </div>
        </div>
      </div>
      <div class="week__body">
        <div class="week__timecol">
          <div class="hour" *ngFor="let h of [].constructor(13); let i=index">{{ (8+i) }}:00</div>
        </div>
        <div class="week__daycol" *ngFor="let d of weekDays">
          <div class="current-line" *ngIf="currentLinePosition(d.iso) !== null" [style.top.px]="currentLinePosition(d.iso)"></div>
          <div class="slot-bg" *ngFor="let h of [].constructor(12)"></div>
          <div class="event" *ngFor="let e of eventsForDay(d.iso)" [ngClass]="e.estadoClass" [style.top.px]="e.top" [style.height.px]="e.height">
            <span class="event__hora">{{ e.cita.inicio | date:'HH:mm' }}</span>
            <strong class="event__titulo">{{ e.title }}</strong>
            <small class="event__estado">{{ e.cita.estado | titlecase }}</small>
            <small class="event__motivo" *ngIf="e.cita.motivo">“{{ e.cita.motivo }}”</small>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="acciones-rapidas" *ngIf="citasProximas.length">
    <header class="citas__header">
      <h2>Acciones rapidas</h2>
      <span>Gestiona sin abrir el evento</span>
    </header>
    <div class="acciones-rapidas__list">
      <article class="mini-card" *ngFor="let cita of citasProximas | slice:0:3">
        <div class="mini-card__info">
          <strong>{{ cita.inicio | date:'EEE d/MM HH:mm' }}</strong>
          <span>{{ cita.odontologo?.nombre || 'Odontologo' }}</span>
          <small class="estado-pill">{{ cita.estado | titlecase }}</small>
        </div>
        <div class="mini-card__actions">
          <button class="btn btn--primary" type="button" (click)="abrirReprogramar(cita)" [disabled]="reprogramandoId === cita.id">Editar</button>
          <button class="btn btn--danger" type="button" (click)="onCancelar(cita.id)" [disabled]="cancelando.has(cita.id)">Cancelar</button>
        </div>
      </article>
    </div>
  </section>

  <section class="features">
    <article class="feature-card">
      <h2>Historial organizado</h2>
      <p>Revisa citas futuras y pasadas con estado actualizado en tiempo real.</p>
    </article>
    <article class="feature-card">
      <h2>Seguimiento personalizado</h2>
      <p>Guarda motivos y recibe notificaciones automaticas antes de cada cita.</p>
    </article>
    <article class="feature-card">
      <h2>Soporte integrado</h2>
      <p>Gestiona cancelaciones, reagendamientos y mensajes desde un solo lugar.</p>
    </article>
  </section>

  <section *ngIf="loading" class="state state--info">
    Cargando citas...
  </section>

  <section *ngIf="errorMsg" class="state state--error">
    {{ errorMsg }}
  </section>

  <section *ngIf="successMsg" class="state state--success">
    {{ successMsg }}
  </section>

  <section class="citas" *ngIf="!loading">
    <div class="citas__bloque">
      <header class="citas__header">
        <h2>Citas proximas</h2>
        <span>{{ citasProximas.length }} agendadas</span>
      </header>

      <div *ngIf="citasProximas.length === 0" class="empty empty--inline">
        No tienes citas proximas. Agenda una nueva para comenzar.
      </div>

      <div class="citas-grid" *ngIf="citasProximas.length > 0">
        <article *ngFor="let cita of citasProximas" class="cita-card">
          <header class="cita-card__header">
            <h3>{{ cita.odontologo?.nombre || 'Odontologo' }}</h3>
            <span class="badge" [ngClass]="{
              'badge--pendiente': cita.estado==='pendiente',
              'badge--confirmada': cita.estado==='confirmada',
              'badge--cancelada': cita.estado==='cancelada',
              'badge--atendida': cita.estado==='atendida'
            }">{{ cita.estado | titlecase }}</span>
          </header>

          <p class="cita-card__fecha">
            {{ cita.inicio | date: 'EEEE d \'de\' MMMM, HH:mm' }} -
            {{ cita.fin | date: 'HH:mm' }}
          </p>

          

          <p class="cita-card__detalle" *ngIf="cita.motivo">
            Motivo: {{ cita.motivo }}
          </p>

          <footer class="cita-card__acciones">
            <button
              class="btn btn--danger"
              type="button"
              *ngIf="cita.estado !== 'cancelada'"
              [disabled]="cancelando.has(cita.id)"
              (click)="onCancelar(cita.id)"
            >
              {{ cancelando.has(cita.id) ? 'Cancelando...' : 'Cancelar cita' }}
            </button>
            <button
              class="btn btn--primary"
              type="button"
              *ngIf="cita.estado !== 'cancelada'"
              (click)="abrirReprogramar(cita)"
            >
              Reprogramar
            </button>
          </footer>

          <div class="reprogramar" *ngIf="reprogramandoId === cita.id">
            <div class="reprogramar__fila">
              <input type="date" [(ngModel)]="reFecha" />
              <button class="btn btn--primary" type="button" (click)="buscarReSlots(cita)" [disabled]="reBuscando">
                {{ reBuscando ? 'Buscando...' : 'Ver horarios' }}
              </button>
              <button class="btn btn--light" type="button" (click)="cerrarReprogramar()">Cerrar</button>
            </div>
            <div class="slots__grid" *ngIf="reSlots.length">
              <button type="button" class="slot" *ngFor="let s of reSlots" (click)="seleccionarReSlot(s)" [class.slot--seleccionado]="reSlotSel?.inicio === s.inicio">
                {{ s.etiqueta }}
              </button>
            </div>
            <div class="reprogramar__accion">
              <button class="btn btn--accent" type="button" (click)="confirmarReprogramar(cita)" [disabled]="reGuardando || !reSlotSel">
                {{ reGuardando ? 'Guardando...' : 'Confirmar reprogramacion' }}
              </button>
            </div>
          </div>
        </article>
      </div>
    </div>

    <div class="citas__bloque">
      <header class="citas__header">
        <h2>Historial de citas</h2>
        <span>{{ citasPasadas.length }} registradas</span>
      </header>

      <div *ngIf="citasPasadas.length === 0" class="empty empty--inline">
        Aun no tienes atenciones previas registradas.
      </div>

      <div class="citas-grid" *ngIf="citasPasadas.length > 0">
        <article *ngFor="let cita of citasPasadas" class="cita-card cita-card--historico">
          <header class="cita-card__header">
            <h3>{{ cita.odontologo?.nombre || 'Odontologo' }}</h3>
            <span class="estado" [ngClass]="cita.estado">
              {{ cita.estado | titlecase }}
            </span>
          </header>

          <p class="cita-card__fecha">
            {{ cita.inicio | date: 'EEEE d \'de\' MMMM, HH:mm' }} -
            {{ cita.fin | date: 'HH:mm' }}
          </p>

          

          <p class="cita-card__detalle" *ngIf="cita.motivo">
            Motivo: {{ cita.motivo }}
          </p>
        </article>
      </div>
    </div>
  </section>
</div>
